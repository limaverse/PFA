<?php
// C:\xampp\htdocs\PFA\transpori\dashuser\view-experience.php
session_start();
require_once 'database.php';

if (!isset($_SESSION['user_id'])) {
    header('Location: /PFA/transpori/login...signup/logsign.php?tab=login');
    exit();
}

$user_id = $_SESSION['user_id'];
$user_name = $_SESSION['user_name'];

if (!isset($_GET['id'])) {
    header('Location: my-experiences.php');
    exit();
}

$experience_id = $_GET['id'];

// Get experience details
$stmt = $conn->prepare("
    SELECT e.*, 
           CONCAT(m.first_name, ' ', m.last_name) as author_name,
           m.email as author_email,
           c.name as category_name
    FROM experiences e
    LEFT JOIN members m ON e.member_id = m.id
    LEFT JOIN categories c ON e.category_id = c.id
    WHERE e.id = ? AND (e.member_id = ? OR e.status = 'approved')
");
$stmt->execute([$experience_id, $user_id]);
$experience = $stmt->fetch();

if (!$experience) {
    header('Location: my-experiences.php');
    exit();
}

// Check if current user can view (must be owner or approved)
if ($experience['member_id'] != $user_id && $experience['status'] != 'approved') {
    header('Location: my-experiences.php');
    exit();
}

// Get comments
$stmt = $conn->prepare("
    SELECT c.*, 
           CONCAT(m.first_name, ' ', m.last_name) as commenter_name
    FROM comments c
    LEFT JOIN members m ON c.member_id = m.id
    WHERE c.parent_type = 'experience' AND c.parent_id = ? AND c.is_approved = TRUE
    ORDER BY c.created_at ASC
");
$stmt->execute([$experience_id]);
$comments = $stmt->fetchAll();
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transpori | View Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/PFA/transpori/home/css/transpori css.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="dashboard-page">
    <!-- Header -->
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="index.php" class="logo">
                    <i class="fas fa-shield-alt"></i>
                    Transpori
                </a>
                <ul class="nav-links">
                    <li><a href="index.php" class="nav-link">Home</a></li>
                    <li><a href="my-experiences.php" class="nav-link">My Experiences</a></li>
                    <li><a href="share.php" class="nav-link">Share Experience</a></li>
                    <li><a href="tips.php" class="nav-link">Safety Tips</a></li>
                    <li><a href="emergency.php" class="nav-link">Emergency Contacts</a></li>
                </ul>
                <div class="auth-buttons">
                    <a href="#" class="profile-btn">
                        <div class="profile-avatar">
                            <?php echo substr($user_name, 0, 2); ?>
                        </div>
                        <span><?php echo htmlspecialchars(explode(' ', $user_name)[0]); ?></span>
                    </a>
                    <a href="logout.php" class="btn btn-outline">Logout</a>
                </div>
                <button class="hamburger">
                    <i class="fas fa-bars"></i>
                </button>
            </nav>
        </div>
    </header>

    <main class="main-content">
        
        <div class="dashboard-header">
            <div>
                <h1 class="text-3xl font-extrabold">View Experience</h1>
                <p class="text-text-secondary">Experience details and comments</p>
            </div>
            <button class="btn btn-outline" onclick="window.location.href='my-experiences.php'">
                <i class="fas fa-arrow-left mr-2"></i> Back to My Experiences
            </button>
        </div>
        
        <div class="glass-card mb-6">
            <!-- Status Badge -->
            <?php if ($experience['status'] == 'pending'): ?>
            <div class="mb-4 inline-flex items-center px-3 py-1 rounded-full text-sm bg-yellow-500/20 text-yellow-400">
                <i class="fas fa-clock mr-1"></i> Pending Review
            </div>
            <?php elseif ($experience['status'] == 'approved'): ?>
            <div class="mb-4 inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-500/20 text-green-400">
                <i class="fas fa-check-circle mr-1"></i> Approved
            </div>
            <?php elseif ($experience['status'] == 'rejected'): ?>
            <div class="mb-4 inline-flex items-center px-3 py-1 rounded-full text-sm bg-red-500/20 text-red-400">
                <i class="fas fa-times-circle mr-1"></i> Rejected
            </div>
            <?php endif; ?>
            
            <?php if ($experience['status'] == 'rejected' && !empty($experience['rejection_reason'])): ?>
            <div class="mb-4 p-4 bg-red-500/10 border border-red-500/20 rounded">
                <div class="text-sm text-red-400">
                    <strong>Rejection Reason:</strong> <?php echo htmlspecialchars($experience['rejection_reason']); ?>
                </div>
            </div>
            <?php endif; ?>
            
            <h2 class="text-2xl font-bold mb-4"><?php echo htmlspecialchars($experience['title']); ?></h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <div class="text-sm text-text-secondary mb-1">Author</div>
                    <div class="font-semibold"><?php echo htmlspecialchars($experience['author_name'] ?: 'Anonymous'); ?></div>
                </div>
                <div>
                    <div class="text-sm text-text-secondary mb-1">Submitted</div>
                    <div class="font-semibold"><?php echo date('F j, Y \a\t g:i A', strtotime($experience['created_at'])); ?></div>
                </div>
                <div>
                    <div class="text-sm text-text-secondary mb-1">Category</div>
                    <div class="font-semibold"><?php echo htmlspecialchars($experience['category_name'] ?: 'Uncategorized'); ?></div>
                </div>
                <div>
                    <div class="text-sm text-text-secondary mb-1">Transport Type</div>
                    <div class="font-semibold"><?php echo htmlspecialchars($experience['transport_type']); ?></div>
                </div>
                <div>
                    <div class="text-sm text-text-secondary mb-1">Experience Type</div>
                    <div class="font-semibold"><?php echo htmlspecialchars($experience['experience_type']); ?></div>
                </div>
                <?php if (!empty($experience['location'])): ?>
                <div>
                    <div class="text-sm text-text-secondary mb-1">Location</div>
                    <div class="font-semibold"><?php echo htmlspecialchars($experience['location']); ?></div>
                </div>
                <?php endif; ?>
            </div>
            
            <div class="mb-6">
                <div class="text-sm text-text-secondary mb-2">Experience</div>
                <div class="p-4 bg-glass-bg rounded whitespace-pre-line">
                    <?php echo nl2br(htmlspecialchars($experience['content'])); ?>
                </div>
            </div>
            
            <div class="flex items-center justify-between border-t border-glass-border pt-4">
                <div class="flex items-center gap-4">
                    <button class="action-btn like-btn" data-id="<?php echo $experience['id']; ?>">
                        <i class="fas fa-thumbs-up"></i>
                        <span><?php echo $experience['likes_count']; ?> likes</span>
                    </button>
                    <button class="action-btn comment-btn">
                        <i class="fas fa-comment"></i>
                        <span><?php echo $experience['comments_count']; ?> comments</span>
                    </button>
                </div>
                
                <?php if ($experience['member_id'] == $user_id): ?>
                <div class="flex gap-2">
                    <?php if ($experience['status'] == 'pending' || $experience['status'] == 'rejected'): ?>
                    <button class="btn btn-outline" onclick="window.location.href='edit-experience.php?id=<?php echo $experience['id']; ?>'">
                        <i class="fas fa-edit mr-1"></i> Edit
                    </button>
                    <?php endif; ?>
                    <button class="btn btn-outline text-red-400 border-red-400 hover:bg-red-400/10"
                            onclick="if(confirm('Are you sure you want to delete this experience?')) { window.location.href='my-experiences.php?delete=<?php echo $experience['id']; ?>'; }">
                        <i class="fas fa-trash mr-1"></i> Delete
                    </button>
                </div>
                <?php endif; ?>
            </div>
        </div>
        
        <!-- Comments Section -->
        <div class="glass-card">
            <h3 class="text-xl font-bold mb-4">Comments (<?php echo count($comments); ?>)</h3>
            
            <?php if (empty($comments)): ?>
            <div class="text-center py-8 text-text-secondary">
                <i class="fas fa-comments text-3xl mb-2"></i>
                <div>No comments yet. Be the first to comment!</div>
            </div>
            <?php else: ?>
            <div class="space-y-4 mb-6">
                <?php foreach ($comments as $comment): ?>
                <div class="p-4 bg-glass-bg rounded">
                    <div class="flex items-start justify-between mb-2">
                        <div class="font-semibold"><?php echo htmlspecialchars($comment['commenter_name']); ?></div>
                        <div class="text-sm text-text-secondary"><?php echo date('M d, Y', strtotime($comment['created_at'])); ?></div>
                    </div>
                    <div class="whitespace-pre-line"><?php echo nl2br(htmlspecialchars($comment['content'])); ?></div>
                </div>
                <?php endforeach; ?>
            </div>
            <?php endif; ?>
            
            <?php if ($experience['status'] == 'approved'): ?>
            <form id="comment-form" class="space-y-3">
                <input type="hidden" name="experience_id" value="<?php echo $experience['id']; ?>">
                <textarea name="comment" class="form-textarea" rows="3" placeholder="Add a comment..."></textarea>
                <button type="submit" class="btn">
                    <i class="fas fa-paper-plane mr-2"></i> Post Comment
                </button>
            </form>
            <?php endif; ?>
        </div>

    </main>

    <script>
    // Like functionality
    const likeBtn = document.querySelector('.like-btn');
    if (likeBtn) {
        likeBtn.addEventListener('click', function() {
            const experienceId = this.getAttribute('data-id');
            
            fetch('ajax/like.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: experienceId,
                    type: 'experience'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const span = likeBtn.querySelector('span');
                    span.textContent = data.newCount + ' likes';
                    
                    // Toggle liked state
                    const icon = likeBtn.querySelector('i');
                    if (icon.classList.contains('text-primary')) {
                        icon.classList.remove('text-primary');
                    } else {
                        icon.classList.add('text-primary');
                    }
                }
            });
        });
    }
    
    // Comment functionality
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('ajax/add_comment.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            });
        });
    }
    </script>
    
    <script src="/PFA/transpori/home/javascript/transpori javascript.js"></script>
    <script src="javascript/main.js"></script>
</body>
</html>